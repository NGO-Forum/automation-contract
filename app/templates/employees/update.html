{% extends "base.html" %}
{% block title %}Update Employee Contract{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/create.css') }}">

<div class="container mt-4">
    <div class="form-header text-center mb-0">
        <h1><i class="bi bi-pencil-square"></i> Update Employee Contract</h1>
    </div>
    <div class="form-card">
        <nav class="mb-4">
            <a href="{{ url_for('employees.index') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Employee List
            </a>
        </nav>

        <form id="employeeForm" action="{{ url_for('employees.update', id=employee.id) }}" method="POST" class="needs-validation" novalidate>
            
            <!-- Employee Details -->
            <div class="section-header mb-4">
                <h5><i class="bi bi-person-badge"></i> Employee Details</h5>
                <hr>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="employee_name" class="form-label fw-bold">Full Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="employee_name" name="employee_name"
                           value="{{ form_data.employee_name | default(employee.employee_name) }}"
                           placeholder="e.g., Mr. Chan Vicheth" required>
                    <div class="invalid-feedback">Please enter full name (including title).</div>
                </div>
                <div class="col-md-6">
                    <label for="position_title" class="form-label fw-bold">Position Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="position_title" name="position_title"
                           value="{{ form_data.position_title | default(employee.position_title) }}"
                           placeholder="e.g., Capacity Development Specialist" required>
                    <div class="invalid-feedback">Please enter position title.</div>
                </div>
                <div class="col-12">
                    <label for="employee_address" class="form-label">Address</label>
                    <textarea class="form-control" id="employee_address" name="employee_address" rows="2"
                              placeholder="Complete address">{{ form_data.employee_address | default(employee.employee_address) }}</textarea>
                </div>
                <div class="col-md-6">
                    <label for="employee_tel" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="employee_tel" name="employee_tel"
                           value="{{ form_data.employee_tel | default(employee.employee_tel) }}"
                           placeholder="e.g., 012 953 650">
                </div>
                <div class="col-md-6">
                    <label for="employee_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="employee_email" name="employee_email"
                           value="{{ form_data.employee_email | default(employee.employee_email) }}"
                           placeholder="e.g., name@example.com">
                </div>
            </div>

            <!-- Contract Details -->
            <div class="section-header mb-4">
                <h5><i class="bi bi-file-earmark-contract"></i> Contract Details</h5>
                <hr>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="contract_no" class="form-label fw-bold">Contract Number <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="contract_no" name="contract_no"
                           value="{{ form_data.contract_no | default(employee.contract_no) }}" required>
                    <div class="invalid-feedback">Please enter contract number.</div>
                </div>
                <div class="col-md-4">
                    <label for="contract_type" class="form-label fw-bold">Contract Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="contract_type" name="contract_type" required>
                        <option value="" disabled>Select Contract Type</option>
                        <option value="Fixed Duration Contract (FDC)" {{ 'selected' if (form_data.contract_type | default(employee.contract_type)) == 'Fixed Duration Contract (FDC)' }}>Fixed Duration Contract (FDC)</option>
                        <option value="Undefined Duration Contract (UDC)" {{ 'selected' if (form_data.contract_type | default(employee.contract_type)) == 'Undefined Duration Contract (UDC)' }}>Undefined Duration Contract (UDC)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="working_hours" class="form-label">Working Hours</label>
                    <input type="text" class="form-control" id="working_hours" name="working_hours"
                           value="{{ form_data.working_hours | default(employee.working_hours) }}">
                </div>
                <div class="col-md-4">
                    <label for="start_date" class="form-label fw-bold">Start Date <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="date" class="form-control" id="start_date" name="start_date"
                               value="{{ form_data.start_date | default(employee.start_date.strftime('%Y-%m-%d') if employee.start_date else '') }}" required aria-describedby="start_date_icon">
                        <span class="input-group-text" id="start_date_icon">
                            <i class="bi bi-calendar"></i>
                        </span>
                        <div class="invalid-feedback">Please select a start date.</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="duration_months" class="form-label fw-bold">Duration <span class="text-danger">*</span></label>
                    <select class="form-select" id="duration_months" name="duration_months" required>
                        <option value="" disabled>Select Duration</option>
                        <option value="3" {{ 'selected' if (form_data.duration_months | default(employee.duration_months | default(12))) == 3 or (form_data.duration_months | default(employee.duration_months | default(12))) == '3' }}>3 Months</option>
                        <option value="6" {{ 'selected' if (form_data.duration_months | default(employee.duration_months | default(12))) == 6 or (form_data.duration_months | default(employee.duration_months | default(12))) == '6' }}>6 Months</option>
                        <option value="12" {{ 'selected' if (form_data.duration_months | default(employee.duration_months | default(12))) == 12 or (form_data.duration_months | default(employee.duration_months | default(12))) == '12' }}>12 Months</option>
                        <option value="24" {{ 'selected' if (form_data.duration_months | default(employee.duration_months | default(12))) == 24 or (form_data.duration_months | default(employee.duration_months | default(12))) == '24' }}>24 Months</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="end_date_display" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date_display" readonly
                           value="{{ form_data.end_date | default(employee.end_date.strftime('%Y-%m-%d') if employee.end_date else '') }}">
                </div>
            </div>

            <!-- Salary and Benefits -->
            <div class="section-header mb-4">
                <h5><i class="bi bi-currency-dollar"></i> Salary & Benefits</h5>
                <hr>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="salary_amount" class="form-label fw-bold">Salary Amount (USD) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="salary_amount" name="salary_amount"
                           value="{{ form_data.salary_amount | default('%.2f' % employee.salary_amount if employee.salary_amount is not none else '0.00') }}" min="0" step="0.01" required>
                    <small id="salary_formatted" class="text-muted"></small>
                    <div class="invalid-feedback">Please enter a valid salary amount.</div>
                </div>
                <div class="col-md-4">
                    <label for="salary_grade" class="form-label">Salary Grade</label>
                    <input type="text" class="form-control" id="salary_grade" name="salary_grade"
                           value="{{ form_data.salary_grade | default(employee.salary_grade) }}" placeholder="e.g., G4/L5">
                </div>
                <div class="col-md-4">
                    <label for="salary_amount_words" class="form-label">Salary Amount (Words)</label>
                    <input type="text" class="form-control" id="salary_amount_words" name="salary_amount_words"
                           value="{{ form_data.salary_amount_words | default(employee.salary_amount_words) }}" readonly>
                </div>
                <div class="col-md-3">
                    <label for="medical_allowance" class="form-label">Medical Allowance</label>
                    <input type="number" class="form-control" id="medical_allowance" name="medical_allowance"
                           value="{{ form_data.medical_allowance | default('%.2f' % employee.medical_allowance if employee.medical_allowance is not none else '150.00') }}" min="0" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="child_education_allowance" class="form-label">Child Education</label>
                    <input type="number" class="form-control" id="child_education_allowance" name="child_education_allowance"
                           value="{{ form_data.child_education_allowance | default('%.2f' % employee.child_education_allowance if employee.child_education_allowance is not none else '60.00') }}" min="0" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="delivery_benefit" class="form-label">Delivery Benefit</label>
                    <input type="number" class="form-control" id="delivery_benefit" name="delivery_benefit"
                           value="{{ form_data.delivery_benefit | default('%.2f' % employee.delivery_benefit if employee.delivery_benefit is not none else '200.00') }}" min="0" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="death_benefit" class="form-label">Death Benefit</label>
                    <input type="number" class="form-control" id="death_benefit" name="death_benefit"
                           value="{{ form_data.death_benefit | default('%.2f' % employee.death_benefit if employee.death_benefit is not none else '200.00') }}" min="0" step="0.01">
                </div>
                <div class="col-md-6">
                    <label for="severance_percentage" class="form-label">Severance (%)</label>
                    <input type="number" class="form-control" id="severance_percentage" name="severance_percentage"
                           value="{{ form_data.severance_percentage | default('%.2f' % employee.severance_percentage if employee.severance_percentage is not none else '8.33') }}" min="0" step="0.01" max="100">
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="thirteenth_month_salary" name="thirteenth_month_salary"
                               {{ 'checked' if (form_data.thirteenth_month_salary | default(employee.thirteenth_month_salary)) }}>
                        <label class="form-check-label" for="thirteenth_month_salary">
                            Include 13th Month Salary
                        </label>
                    </div>
                </div>
            </div>

            <!-- Organization Details -->
            <div class="section-header mb-4">
                <h5><i class="bi bi-building"></i> Organization Details</h5>
                <hr>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="organization_name" class="form-label">Organization Name</label>
                    <input type="text" class="form-control" id="organization_name" name="organization_name"
                           value="{{ form_data.organization_name | default(employee.organization_name) }}">
                </div>
                <div class="col-md-4">
                    <label for="representative_name" class="form-label">Representative Name</label>
                    <input type="text" class="form-control" id="representative_name" name="representative_name"
                           value="{{ form_data.representative_name | default(employee.representative_name) }}">
                </div>
                <div class="col-md-4">
                    <label for="representative_title" class="form-label">Representative Title</label>
                    <input type="text" class="form-control" id="representative_title" name="representative_title"
                           value="{{ form_data.representative_title | default(employee.representative_title) }}"
                           placeholder="e.g., Executive Director">
                </div>
                <div class="col-12">
                    <label for="organization_address" class="form-label">Address</label>
                    <textarea class="form-control" id="organization_address" name="organization_address" rows="2">{{ form_data.organization_address | default(employee.organization_address) }}</textarea>
                </div>
                <div class="col-md-4">
                    <label for="organization_tel" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="organization_tel" name="organization_tel"
                           value="{{ form_data.organization_tel | default(employee.organization_tel) }}">
                </div>
                <div class="col-md-4">
                    <label for="organization_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="organization_email" name="organization_email"
                           value="{{ form_data.organization_email | default(employee.organization_email) }}">
                </div>
                <div class="col-md-4">
                    <label for="organization_fax" class="form-label">Fax</label>
                    <input type="text" class="form-control" id="organization_fax" name="organization_fax"
                           value="{{ form_data.organization_fax | default(employee.organization_fax) }}">
                </div>
            </div>

            <!-- Signatures -->
            <div class="section-header mb-4">
                <h5><i class="bi bi-pen"></i> Signatures</h5>
                <hr>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="employer_signature_name" class="form-label">Employer Signature</label>
                    <input type="text" class="form-control" id="employer_signature_name" name="employer_signature_name"
                           value="{{ form_data.employer_signature_name | default(employee.employer_signature_name) }}">
                </div>
                <div class="col-md-6">
                    <label for="employee_signature_name" class="form-label">Employee Signature</label>
                    <input type="text" class="form-control" id="employee_signature_name" name="employee_signature_name"
                           value="{{ form_data.employee_signature_name | default(employee.employee_signature_name) }}">
                </div>
            </div>

            <!-- Submit -->
            <div class="text-center mt-5">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-save"></i> Update Employee Contract
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('employeeForm');
    form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
        // Ensure salary_amount_words is sent to the server
        const salaryWordsInput = document.getElementById('salary_amount_words');
        salaryWordsInput.removeAttribute('readonly');
    }, false);

    // Date pickers
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.addEventListener('click', () => input.showPicker());
        const calendarIcon = input.parentElement.querySelector('.input-group-text');
        if (calendarIcon) {
            calendarIcon.addEventListener('click', () => {
                input.focus();
                input.showPicker();
            });
        }
    });

    // Calculate end date
    const startDateInput = document.getElementById('start_date');
    const durationSelect = document.getElementById('duration_months');
    const endDateDisplay = document.getElementById('end_date_display');
    function calculateEndDate() {
        const startDate = startDateInput.value;
        const duration = parseInt(durationSelect.value) || 12;
        if (startDate) {
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(start);
            end.setMonth(start.getMonth() + duration);
            end.setDate(0); // Set to last day of the previous month
            endDateDisplay.value = end.toISOString().split('T')[0];
        } else {
            endDateDisplay.value = '';
        }
    }
    startDateInput.addEventListener('change', calculateEndDate);
    durationSelect.addEventListener('change', calculateEndDate);

    // Salary conversion
    const salaryAmount = document.getElementById('salary_amount');
    const salaryWords = document.getElementById('salary_amount_words');
    const salaryFormatted = document.getElementById('salary_formatted');

    function numberToWords(num) {
        if (num === 0) return 'Zero';
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const scales = ['', 'Thousand', 'Million', 'Billion'];

        function chunkToWords(n) {
            let words = '';
            const hundred = Math.floor(n / 100);
            const remainder = n % 100;
            if (hundred > 0) words += ones[hundred] + ' Hundred ';
            if (remainder > 0) {
                if (remainder < 10) words += ones[remainder];
                else if (remainder < 20) words += teens[remainder - 10];
                else {
                    words += tens[Math.floor(remainder / 10)];
                    if (remainder % 10 > 0) words += '-' + ones[remainder % 10].toLowerCase();
                }
            }
            return words.trim();
        }

        const parts = [];
        let scaleIndex = 0;
        while (num > 0) {
            const chunk = num % 1000;
            if (chunk > 0) parts.unshift(chunkToWords(chunk) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : ''));
            num = Math.floor(num / 1000);
            scaleIndex++;
        }
        return parts.join(' ').replace(/\s+/g, ' ').trim();
    }

    function convertSalaryToWords() {
        const value = parseFloat(salaryAmount.value);
        if (isNaN(value) || value < 0) {
            salaryWords.value = '';
            salaryFormatted.textContent = '';
            return;
        }
        const integerPart = Math.floor(value);
        const decimalPart = Math.round((value - integerPart) * 100);
        let words = numberToWords(integerPart) + ' US Dollars';
        if (decimalPart > 0) words += ' and ' + numberToWords(decimalPart) + ' Cents';
        words += ' only';
        salaryWords.value = words;
        salaryFormatted.textContent = 'Formatted: $' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    salaryAmount.addEventListener('input', convertSalaryToWords);

    // Auto-fill employee signature
    const employeeName = document.getElementById('employee_name');
    const employeeSignature = document.getElementById('employee_signature_name');
    employeeName.addEventListener('input', () => employeeSignature.value = employeeName.value);

    // Initialize form
    calculateEndDate();
    convertSalaryToWords();
});
</script>
{% endblock %}
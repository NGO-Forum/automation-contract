{% extends "base.html" %}
{% block title %}View Contract - {{ contract.contract_number }}{% endblock %}
{% block content %}
<!-- Navigation Buttons -->
<div class="d-flex justify-content-center mt-3 mb-2 gap-2">
    <a href="{{ url_for('contracts.index') }}" class="btn btn-secondary">Back to List</a>
    <a href="{{ url_for('contracts.export_docx', contract_id=contract.id) }}" class="btn btn-primary">Export to DOCX</a>
</div>

<div class="container d-flex justify-content-center mt-3">
    <div class="container-card shadow-sm p-5 mb-3" style="font-family: Calibri, sans-serif; max-width: 750px;">

        <!-- Header -->
        <h1 class="text-center mt-5" style="font-size: 18px; font-weight: bold;">The Service Agreement</h1>
        <p class="text-center" style="font-weight: bold; font-size: 14px;">ON</p>
        <h2 class="text-center" style="font-size: 18px;"><strong>{{ contract.project_title or 'N/A' }}</strong></h2>
        <p class="text-center" style="font-weight: bold; font-size: 18px;">No.: {{ contract.contract_number or 'N/A' }}</p>
        <p class="text-center" style="font-size: 16px;">BETWEEN</p>

        <!-- Party A -->
        {% for person in party_a_info %}
            <p class="text-center" style="font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                <strong>{{ person.organization or 'The NGO Forum on Cambodia' }}</strong>, represented by 
                <strong>{{ person.name or 'Mr. SOEUNG Saroeun' }}</strong>, {{ person.position or 'Executive Director' }}.<br>
                Address: {{ person.address or '#9-11, Street 476, Sangkat Tuol Tumpoung I, Phnom Penh, Cambodia' }}.<br>
                hereinafter called the “<strong>Party A</strong>”
            </p>
            {% if not loop.last %}
                <p class="text-center" style="font-size: 16px;">AND</p>
            {% endif %}
        {% endfor %}

        <p class="text-center" style="font-size: 16px;">AND</p>

        <!-- Party B -->
        <p class="text-center" style="font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
            {% for person in party_b_info %}
                <strong>{{ person.position or 'Freelance Consultant' }} {{ person.name or 'N/A' }}</strong>{% if not loop.last %}; {% endif %}
            {% endfor %},<br>
            Address: {{ party_b_info[0].address or 'N/A' }}<br>
            H/P: {{ party_b_info[0].phone or 'N/A' }}, E-mail: <span style="color: blue; text-decoration: underline;">{{ party_b_info[0].email or 'N/A' }}</span><br>
            hereinafter called the “<strong>Party B</strong>”
        </p>

        <!-- Whereas Clauses -->
        {% for person in party_a_info %}
            <p class="text-justify" style="font-size: 14px; line-height: 1.8; margin-bottom: 15px;">
                Whereas <strong>{{ person.short_name or person.organization or 'NGOF' }}</strong> is a legal entity registered with the Ministry of Interior (MOI)
                {% if person.registration_number %} {{ person.registration_number }}{% endif %}
                {% if person.registration_date %} dated {{ person.registration_date }}{% endif %}.
            </p>
        {% endfor %}
        <p class="text-justify" style="font-size: 14px; line-height: 1.8; margin-bottom: 15px;">
            Whereas {% if party_a_info|length > 1 %}{{ party_a_info[:-1]|map(attribute='short_name')|join(', ') }} and {{ party_a_info[-1].short_name }}{% else %}{{ party_a_info[0].short_name or party_a_info[0].organization or 'NGOF' }}{% endif %}
            will engage the services of “<strong>Party B</strong>” which accepts the engagement under the following terms and conditions.
        </p>
        <p class="text-center" style="font-weight: bold; font-size: 14px; margin-bottom: 20px;">Both Parties Agreed as follows:</p>

        <!-- Articles -->
        {% for article in standard_articles %}
            <h6 class="mb-1" style="font-weight: bold; margin: 0;">
                <span style="text-decoration: underline;">ARTICLE {{ article.number }}:</span> {{ article.title }}
            </h6>
            <p class="text-justify" style="white-space: pre-line; font-size: 14px; line-height: 1.6; margin: 0;">
                {{ article.content | safe }}
            </p>

            {% if article.table %}
                <table class="table table-bordered" style="border: 1px solid black; margin: 10px 0; width: 100%;">
                    <thead>
                        <tr>
                            {% for key in article.table[0].keys() %}
                                <th class="text-center text-black" style="border: 1px solid black; padding: 8px; 
                                    {% if key == 'Total Amount (USD)' %}width: 20%;
                                    {% elif key == 'Installment' %}width: 15%;
                                    {% elif key == 'Deliverable' %}width: 50%;
                                    {% elif key == 'Due date' %}width: 15%;
                                    {% endif %}">
                                    {{ key }}
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in article.table[1:] %}
                            <tr>
                                {% for key in row.keys() %}
                                    <td style="white-space: pre-wrap; border: 1px solid black; padding: 8px; vertical-align: top;
                                        {% if key == 'Total Amount (USD)' %}font-weight: bold;{% endif %}">
                                        {{ row[key] | safe }}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% for custom in custom_articles %}
                {% if custom.article_number | string == article.number | string %}
                    <p class="text-justify" style="white-space: pre-line; font-size: 14px; line-height: 1.6; margin: 0;">
                        {{ custom.custom_sentence }}
                    </p>
                {% endif %}
            {% endfor %}
        {% endfor %}

        <!-- Signatures -->
        <p class="text-center mt-3 mb-2" style="font-weight: bold; font-size: 15px;">
            Date: {{ contract.agreement_start_date_display or 'N/A' }}
        </p>
        <table class="table table-borderless" style="margin-left: 17%; font-size: 15px;">
            <tr>
                <td class="text-start" style="width: 50%;">
                    <div style="margin-bottom: 50px;">
                        <strong>For “Party A”</strong>
                    </div>
                    {% if party_a_info|length == 1 %}
                        <!-- Single Party A signatory (original layout) -->
                        {% for person in party_a_info %}
                            {% if person.name == contract.party_a_signature_name or loop.first %}
                                _________________<br>
                                <strong>{{ person.name or 'Mr. SOEUNG Saroeun' }}</strong><br>
                                <strong>{{ person.position or 'Executive Director' }}</strong>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <!-- Multiple Party A signatories -->
                        {% for person in party_a_info %}
                            _________________<br>
                            <strong>{{ person.name or 'Mr. SOEUNG Saroeun' }}</strong><br>
                            <strong>{{ person.position or 'Executive Director' }}</strong>
                            {% if not loop.last %}<br><br>{% endif %}
                        {% endfor %}
                    {% endif %}
                </td>
                <td class="text-start" style="width: 50%;">
                    <div style="margin-bottom: 40px;">
                        <strong>For “Party B”</strong>
                    </div>
                    _________________<br>
                    {% for person in party_b_info %}
                        {% if person.name == contract.party_b_signature_name %}
                            <strong>{{ person.name or 'N/A' }}</strong><br>
                            <strong>{{ person.position or 'Freelance Consultant' }}</strong>
                        {% endif %}
                    {% endfor %}
                </td>
            </tr>
        </table>
    </div>
</div>
{% endblock %}